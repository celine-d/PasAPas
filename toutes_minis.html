<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    	slice:hover {
        fill: grey;
        opacity : 0.6;
      }
      rect:hover {
        fill: #fcfcfc;
        opacity : 0.6;
      }
    	.hidden {
        display: none;
    	}
   		div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute; 
    	} 
  </style>
</head>

<body>
  
  <form>
    Année :
    <label><input type="checkbox" id="check16" checked = "checked"> 2016</label>
    <label><input type="checkbox" id="check17" checked = "checked"> 2017</label>
    <label><input type="checkbox" id="check18" checked = "checked"> 2018</label>
    <label><input type="checkbox" id="check19" checked = "checked"> 2019</label>  
  </form>
  
   <p style=font-size:12px;>
     
  <tr><td>Nombre de pas :
  <select id = steps>
  <option value="nosteps">Aucun</option>
  <option value="five_steps">5 000 pas : faiblement actif </option>
  <option value="seven_steps">7 500 pas : modérément actif</option>
  <option value="ten_steps">10 000 pas : recommandation santé</option>
  <option value="fifteen_steps">15 000 pas</option>
    </select></td>
     
  <td><br>Référence :
  <select id = ref>
  <option value="noref">Aucune</option>
  <option value="big_mac">en Big Mac : 503 kcal </option>
  <option value="coke">en canette de Coca-Cola (330mL) : 139 kcal</option>
  <option value="boxe">en minute(s) de boxe : 300 pas</option>
  <option value="swim">en minute(s) de nage lente : 100 pas</option>
    </select></td></tr> 
    
  <td><tr>   
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
   Distance référence :
  <select id = distance_ref>
  <option value="saint_etienne">Lyon-Saint-Étienne : 63 km</option>
  <option value="clermont_ferrand">Lyon-Clermont-Ferrand : 164 km</option>
    <option value="montpellier">Lyon-Montpellier : 301 km</option>
  </select></tr></td>
</p>

  


  
  <script>
    
  	var margin = {top: 0, right: 10, bottom: 20, left: 20};
    
		var width = 960 - margin.left - margin.right,
    	height = 500 - margin.top - margin.bottom;
    
  	var format = d3.format(",d");

    // Transformer la date dans le format conventionnel
    var parseDate = d3.timeParse("%d-%b-%Y %H:%M");
    var parseDate2 = d3.timeParse("%m_%Y"); 

    // Récupérer l'année, le mois, le jour de la semaine 
    var formatAnnee = d3.timeFormat("%Y");
    var formatMois = d3.timeFormat("%B");
    var formatJour = d3.timeFormat("%d");
    var formatJourSemaine = d3.timeFormat("%A");
    
    // Affichage avec espace entre les milliers
    var locale = d3.formatLocale({
  		decimal: ",",
  		thousands: " ",
  		grouping: [3]
		});
    
    // Arrondi et pourcentage
    var Arrondi = locale.format(",.0f");
    var Arrondi1 = locale.format(",.1f"); 
    var Pourcentage = d3.format(".0%");
    
    // Traduction du jour de la semaine en français
    dictSemaine = {'Sunday':'Dimanche','Monday':'Lundi','Tuesday':'Mardi','Wednesday':'Mercredi','Thursday':'Jeudi','Friday':'Vendredi','Saturday':'Samedi'};
    
    // Traduction du mois en français
    dictMois = {'January':'Janvier','February':'Février','March':'Mars','April':'Avril','May':'Mai','June':'Juin','July':'Juillet','August':'Août','September':'Septembre','October':'Octobre','November':'Novembre','December':'Décembre'};
    
    // Couleurs
    var colors = {'2016': "#d62728", '2017' : "#2ca02c" , '2018' : "#1f77b4", '2019' : "#ff7f0e"}
    
    // Tooltip
    var tooltip = d3.select("body").append("div") 
    	.attr("class", "tooltip")       
      .style("opacity", 0);
    
    // Fonction permettant de tester si value est dans array
    function isInArray(value,array){
      k = false;
      Array.from(array).forEach(function(d){
        if (d == value){
          k = true;
        }
      })
      return (k)
    }
    
    // Initialisation de la distance pour le barchart
    var distance="saint_etienne";
     
    // Initialisation des données pour le scatterplot
    var steps='nosteps';
    var ref='noref';
    
    // Création du svg
     var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left +"," + margin.top +")");
    
    
    // ---------------------------------------------
    // Fonction permettant de tracer le scatterplot
    // ---------------------------------------------
    
    function scatterplot(width,height,array){
      
    d3.csv('https://raw.githubusercontent.com/celine-d/PasAPas/master/Health%20Data_jour.csv',function(error,rawdata){
      rawdata.forEach(function(d){
        d.start=parseDate(d.Start); //mettre sous une forme de date année les données
        d.steps=+d["Steps (count)"]; 
      });
      
    // On supprime tous les points pour les remplacer par la suite 
    svg.selectAll('.dotscatter').remove();
  	
    // On filtre les données selon les années 
  	data=rawdata.filter(function(d,i){return isInArray(+formatAnnee(d.start),array)})
    
    var x=d3.scaleTime()
    .domain(d3.extent(data,function(data){return data.start;})) //date en x
    .range([40,width-margin.left])//sur espace graphique
    
    var y=d3.scaleLinear() //fonction de correspondance entre deux rangs de valeurs
    .domain([d3.min(data,function(data){return data.steps;}),d3.max(data,function(data){return data.steps;})]) //données de prix en y
    .range([height-40,0])//espace sur l'écran que l'on veut occuper
    
    // Axe des x
    var xAxis = d3.axisBottom()
  	.scale(x)
    .tickFormat(function(d){
     return dictMois[formatMois(d)]+' '+formatAnnee(d);}); 
    
    // Axe des y
    var yAxis = d3.axisLeft()
  	.scale(y);
      
    // Echelle de couleurs
    var color = d3.scaleOrdinal(d3.schemeCategory10)
     svg.selectAll(".dotscatter")
      .data(data)
    .enter().append("circle")
      .style("fill", "orange")
      .attr("class", "dotscatter")
     	.attr("r", 2.4)
      .attr("cx", function(d) { return x(d.start); })
      .attr("cy", function(d) { return y(d.steps); }) 
      .on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          })
          tooltip.classed('hidden', false)
            			.attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 											'px')
            			.html(formatJour(d.start) +" "+ dictMois[formatMois(d.start)]+" "+ 												formatAnnee(d.start) +"<br>"+ Arrondi(d.steps) + " pas")
     			})
        					.on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
     
    // Ajout de l'axe des x
    svg.append('g') //groupe dans lequel on met tout pour créer un axe
  		.attr('transform', 'translate(0,' + 164 + ')') //positions (x,y)
  		.attr('class', 'x axis')
  		.call(xAxis.ticks(d3.timeMonth.every(6)));
      
    // Ajout du nom de l'axe des x
    svg.append("text")             
     .attr("x", width-margin.left-230)
     .attr("y", height-10 )
     .text("Date")
     .style("font-family","sans-serif")
     .style("font-size","13px")
    
    // Ajout de l'axe des y
    svg.append('g') //groupe dans lequel on met tout pour créer un axe
    .attr('transform','translate(40,' + 0 + ')')
  	.attr('class', 'y axis')
  	.call(yAxis)
    
    // Ajout du nom de l'axe des y
    svg.append("text")
     .attr("transform", "rotate(-90)")
     .attr("y", 0 - margin.left)
     .attr("x",0 - (height / 2))
     .attr("dy", "1em")
     .text("Nombre de pas")
     .style("font-family","sans-serif")
     .style("font-size","13px")
    
    // On exécute les fonctions correspondant aux options sélectionnées
    if (steps=='nosteps'){
    	color_normal();
 		}  
  	if (steps=='five_steps'){
    	color_five();
  	}  
    if (steps=='ten_steps'){
    	color_ten();
  	}  
   	if (steps=='seven_steps'){
    	color_seven();
  	}  
   	if (steps=='fifteen_steps'){
    	color_fifteen();
  	} 
  	if (ref=='noref'){
    	size_noref();
  	}  
  	if (ref=='big_mac'){
    	size_bigmac();
  	}  
   	if (ref=='coke'){
    	size_coke();
  	}  
   	if (ref=='boxe'){
    	size_boxe();
  	}  
   	if (ref=='swim'){
   		size_swim();
  	}  
      
  function color_normal() {
   svg.selectAll(".dotscatter")
        .data(data)
  .style("fill", "orange");
  }
      
  function color_five() {
   svg.selectAll(".dotscatter")
        .data(data)
  .style("fill", function(d) {
              if (d.steps <= 5000) {return "red"}
              else 	{ return "green" }
          ;})
  }
      
  function color_seven() {
   svg.selectAll(".dotscatter")
        .data(data)
  .style("fill", function(d) {
              if (d.steps <= 7500) {return "red"}
              else 	{ return "green" }
          ;})
  }
      
  function color_ten() {
   svg.selectAll(".dotscatter")
        .data(data)
  .style("fill", function(d) {
              if (d.steps <= 10000) {return "red"}
              else 	{ return "green" }
          ;})
  }
      
  function color_fifteen() {
     svg.selectAll(".dotscatter")
        .data(data)
  .style("fill", function(d) {
              if (d.steps <= 15000) {return "red"}
              else 	{ return "green" }
          ;})
  }
      
  function size_noref() {
    svg.selectAll(".dotscatter")
        .data(data)
        .attr("r", 2.4)
        .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 											'px')
                    .html(formatJour(d.start) +" "+dictMois[formatMois(d.start)]+" "+ 													formatAnnee(d.start) +"<br> "+ Arrondi(d.steps) + " pas")
       			})
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            });  
  }      
      
  function size_coke() {
    data.forEach(function(d){
      d.nb_coke=d.steps/3971;})
    svg.selectAll(".dotscatter")
    .data(data)
    .attr("r", function(d){return d.nb_coke*2})
    .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 											'px')
                    .html(formatJour(d.start) +" "+ dictMois[formatMois(d.start)]+" "+ 													formatAnnee(d.start) +"<br>"+ Arrondi(d.steps) + " pas"+"																	<br>"+Arrondi1(d.nb_coke)+ " canette(s) de Coca-Cola")
      			})
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            });
  }
        
  
  function size_bigmac() {
       data.forEach(function(d){
      d.nb_bigmac=d.steps/14371;})
       svg.selectAll(".dotscatter")
       .data(data)
       .attr("r", function(d){return d.nb_bigmac*3})
       .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 											'px')
                    .html(formatJour(d.start) +" "+ dictMois[formatMois(d.start)]+" "+ 													formatAnnee(d.start) +"<br>"+ Arrondi(d.steps) + " pas"+"							                    <br>"+Arrondi1(d.nb_bigmac)+ " Big Mac(s)")
       			})
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            }); 
  }
    
  function size_boxe() {
    data.forEach(function(d){
      d.nb_boxe=d.steps/300;})
    svg.selectAll(".dotscatter")
    .data(data)
    .attr("r", function(d){return d.nb_boxe*0.2})
    .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 												'px')
                    .html(formatJour(d.start) +" "+ dictMois[formatMois(d.start)]+" "+ 													formatAnnee(d.start) +"<br>"+ Arrondi(d.steps) + " pas"+"					                         <br>"+Arrondi(d.nb_boxe)+ " minutes de boxe")
      			 })
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            });

  }
         
  function size_swim() {
       data.forEach(function(d){
      d.nb_swim=d.steps/100;})
       d3.select("input[value=\"nofood\"]").attr('checked','true')
       svg.selectAll(".dotscatter")
       .data(data)
       .attr("r", function(d){return d.nb_swim*0.08})
       .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 							'px')
                    .html(formatJour(d.start) +" "+ dictMois[formatMois(d.start)]+" "+ 									formatAnnee(d.start) +"<br>"+ Arrondi(d.steps) + " pas"+"						                       <br>"+Arrondi(d.nb_swim)+ " minutes de nage lente")
       			})
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            });
  }

	})} 
      
    
    // -----------------------------------------
    // Fonction permettant de tracer le barchart
    // -----------------------------------------
    
    function barchart(width,height,array){
      
      // On supprime les barres et le texte pour les remplacer par la suite
      svg.selectAll(".bar").remove();
      svg.selectAll("text").remove();
      
      d3.csv('https://raw.githubusercontent.com/celine-d/PasAPas/master/Health%20Data_moisdistancetri.csv',function(error,rawdata){
      rawdata.forEach(function(d){
        d.mois = parseDate2(d.Mois)
        d.distance=+d.Distance;
      });
        
      var x = d3.scaleLinear()
          .range([width*0.15, width*0.95])
    			.domain([0,5]);
      
    	var xAxisBarchart=d3.axisBottom()
    			.scale(x);
        
      // On filtre les données selon les années
    	data=rawdata.filter(function(d,i){return isInArray(+formatAnnee(d.mois),array)})
      
   	 var y_mois=d3.scaleTime()
    		.domain(d3.extent(data,function(data){return data.mois;}))
    		.range([height*0.742,0])//sur espace graphique
    
     var MoisAxis= d3.axisLeft()
      	.scale(y_mois)
     		.tickFormat(function(d){
       		return dictMois[formatMois(d)]+' '+formatAnnee(d);});

     // Ajout des barres
     svg.selectAll(".bar")
      .data(data)
      .enter().append("rect")
      .attr("class", "bar")
    	.style("fill", "grey")
      .attr('transform','translate(540,'+ 10 + ')')
      .attr("width", function(d) {console.log(d.distance); return x(d.distance)/63; } )
      .attr("y", function(d) { return y_mois(d.mois); })
      .attr("height", 5)
    	.on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          })
          tooltip.classed('hidden', false)
            			.attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 'px')
            			.html(dictMois[formatMois(d.mois)]+' '+formatAnnee(d.mois)+"<br>"+ Arrondi(d.distance) + " km"+"<br>"+Arrondi1(d.distance/63)+" Lyon-Saint-Étienne")
     })
        					.on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
       
		// Ajout de l'axe des x
     svg.append('g')
  	.attr('transform', 'translate(470,'+ 165 + ')')
  	.attr('class', 'x axis Barchart')
  	.call(xAxisBarchart)
    
     // Ajout de nom de l'axe des x
     svg.append("text")             
     .attr("x", width+220)
     .attr("y", height-margin.top-8)
     .text("Proportion")
     .style("font-family","sans-serif")
     .style("font-size","13px")
     
     // Ajout de l'axe des y
     svg.append('g') //groupe dans lequel on met tout pour créer un axe
    .attr('transform','translate(540,'+ 10 + ')')
  	.attr('class', 'y axis')
  	.call(MoisAxis)

     // Ajout du nom de l'axe des y
     svg.append("text")
     .attr("transform", "rotate(-90)")
     .attr("y", 0 - margin.left + width + 5)
     .attr("x",0 - (height / 2))
     .attr("dy", "1em")
     .text("Date")
     .style("font-family","sans-serif")
     .style("font-size","13px")
     
     // Exécution de la fonction correspondant à la référence de distance sélectionnée
     if (distance=='saint_etienne'){
      size_stetienne(y_mois);
    	}  
    if (distance=='clermont_ferrand'){
      size_clermontferrand(y_mois);
    	}  
     if (distance=='montpellier'){
      size_montpellier(y_mois);
    	}     

		function size_stetienne(y_mois) {
   
      // Modification de l'axe des x
      x.domain([0,5])
      xAxisBarchart.scale(x)
      d3.selectAll('g.x.axis.Barchart')
      .transition()
      .call(xAxisBarchart)

      // Modification des barres
      svg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .style("fill", "grey")
        .attr('transform','translate(540,'+ 10 + ')')
        .attr("width", function(d) {return x(d.distance)/63; } )
        .attr("y", function(d) { return y_mois(d.mois); })
        .attr("height", 5)
        .on('mousemove', function(d) {
            var mouse = d3.mouse(svg.node()).map(function(d) {
              return parseInt(d);
            })
            tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 											'px')
                    .html(dictMois[formatMois(d.mois)]+' '+formatAnnee(d.mois)+"<br>"+ 												Arrondi(d.distance) + " km"+"<br>"+Arrondi1(d.distance/63)+" Lyon-													Saint-Étienne")
       			})
                    .on('mouseout', function() {
            tooltip.classed('hidden', true);
            });
		}
      
    function size_clermontferrand(y_mois) {
      	
        // Modification de l'axe des x
        x.domain([0,2])
        xAxisBarchart.scale(x)
        d3.selectAll('g.x.axis.Barchart')
        .transition()
        .call(xAxisBarchart);

        // Modification des barres
        svg.selectAll(".bar")
          .attr("class", "bar")
          .style("fill", "orange")
          .attr('transform','translate(540,'+ 10 + ')')
          .attr("width", function(d) {return x(d.distance)/164; } )
          .attr("y", function(d) { return y_mois(d.mois); })
          .attr("height", 5)
          .on('mousemove', function(d) {
              var mouse = d3.mouse(svg.node()).map(function(d) {
                return parseInt(d);
              })
              tooltip.classed('hidden', false)
                      .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 												'px')
                      .html(dictMois[formatMois(d.mois)]+' '+formatAnnee(d.mois)+"<br>"+ 													Arrondi(d.distance) + " km"+"<br>"+Arrondi1(d.distance/164)+" 														Lyon-Clermont-Ferrand")
         })
                      .on('mouseout', function() {
              tooltip.classed('hidden', true);
              });
    }
      
    function size_montpellier(y_mois) {
      
        // Modification de l'axe des x
        x.domain([0,1.2])
        xAxisBarchart.scale(x)
        d3.selectAll('g.x.axis.Barchart')
        .transition()
        .call(xAxisBarchart)

        // Modification des barres
        svg.selectAll(".bar")
          .attr("class", "bar")
          .style("fill", "blue") 
          .attr('transform','translate(540,'+ 10 + ')')
          .attr("width", function(d) {return x(d.distance)/301; } )
          .attr("y", function(d) { return y_mois(d.mois); })
          .attr("height", 5)
          .on('mousemove', function(d) {
              var mouse = d3.mouse(svg.node()).map(function(d) {
                return parseInt(d);
              })
              tooltip.classed('hidden', false)
                      .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 'px')
                      .html(dictMois[formatMois(d.mois)]+' '+formatAnnee(d.mois)+"<br>"+ Arrondi(d.distance) + " km"+"<br>"+Arrondi1(d.distance/301)+" Lyon-Montpellier")
         })
                      .on('mouseout', function() {
              tooltip.classed('hidden', true);
              });
    }
           
	})}
    
    
    // -----------------------------------------
    // Fonction permettant de tracer le treemap
    // -----------------------------------------
    
    function treemap(width,height,valuex,valuey,array){
      
      var stratify = d3.stratify()
    	.parentId(function(d) {return d.id.substring(0, d.id.lastIndexOf(".")); });

      var treemap = d3.treemap()
      .size([width, height])
      .padding(2)
      .round(true);
      
      // On supprime les rectangles et les textes dans les rectangles pour les remplacer
      svg.selectAll("rect").remove();
      svg.selectAll(".periodeText").remove();
      svg.selectAll(".valueText").remove();
      svg.selectAll(".pourcentageText").remove();

      d3.csv('https://raw.githubusercontent.com/celine-d/PasAPas/master/Health%20Data_jour.csv', function(data) { 
    
    data.forEach(function(d, i){
      
      d.Date = parseDate(d.Start);
      d.Steps = +d['Steps (count)'];  
      d.Mois = formatMois(d.Date);
      d.Annee = formatAnnee(d.Date); 
      d.NumJour = formatJour(d.Date);
 
      // Définition des saisons     
      if (d.Date <= parseDate("21-Mar-"+d.Annee+" 00:00"))   
        d.Saison = 'Hiver';   
      else if (d.Date <= parseDate("21-Jun-"+d.Annee+" 00:00"))   
        d.Saison = 'Printemps';       
      else if (d.Date <= parseDate("21-Sep-"+d.Annee+" 00:00"))   
        d.Saison = 'Été';    
      else if (d.Date <= parseDate("21-Dec-"+d.Annee+" 00:00"))   
        d.Saison = 'Automne';       
      else
        d.Saison = 'Hiver';    
    })  
    
    // Regroupement des données par année puis saison
    var raw_nested = d3.nest()
    		.key(function(d){ return d.Annee; })
				.key(function(d){ return d.Saison; })
				.entries(data); 
     
    // Filtre sur les années sélectionnées
    nested = raw_nested.filter(function(d){return isInArray(+d.key, array)});

    data_tree = [];
    obj = {};
    obj.id = "data";
    obj.value = 0;
    data_tree.push(obj);
      
    nested.forEach(function(d,i){
      	var annee = d.key;
      	obj = {};
      	obj.id = "data."+annee;
      	obj.value = 0;
      	data_tree.push(obj);
        newdata = d.values;
      	newdata.forEach(function(e,j){
          obj = {};
          var saison = e.key;
          newdata2 = e.values;
          obj.id = "data."+annee+"."+saison;
          obj.value = d3.sum(newdata2, function(f) {
  					return f.Steps;})
          data_tree.push(obj)
					})
        });

      var root = stratify(data_tree)
      .sum(function(d) { return d.value; })
      .sort(function(a, b) { return b.height - a.height || b.value - a.value; });
      
       treemap(root);

			 var x = d3.scaleLinear()
            .domain([0, width])
            .range([0, width]);
      
        var y = d3.scaleLinear()
            .domain([0, height])
            .range([0, height]);
 
      var feuilles = root.leaves();
      feuilles.forEach(function(d){
        d.year = d.id.substring(d.id.lastIndexOf(".")-4, d.id.lastIndexOf("."));
        d.season = d.id.substring(d.id.lastIndexOf(".") + 1);
        d.pourcentage = d.value / d.parent.value;
      })
			
      
      // Définition des échelles de couleurs pour chaque année
      
			var color2016 = d3.scaleLinear()
      	.range(["#ffe6e6","#ff8080"])
				.domain([d3.min(feuilles, function(d) {if (d.year == 2016) return d.value; }),
                d3.max(feuilles, function(d) {if (d.year == 2016) return d.value; })]);
      
      var color2017 = d3.scaleLinear()
      .range(["#ccffeb","#2EBA4A"])
				.domain([d3.min(feuilles, function(d) {if (d.year == 2017) return d.value; }),
                d3.max(feuilles, function(d) {if (d.year == 2017) return d.value; })]);
      
      var color2018 = d3.scaleLinear()
      	.range(["#cce6ff","#677AFA"])
				.domain([d3.min(feuilles, function(d) {if (d.year == 2018) return d.value; }),
                d3.max(feuilles, function(d) {if (d.year == 2018) return d.value; })]);
      
      var color2019 = d3.scaleLinear()
      	.range(["#ffffcc","#ffd633"])
				.domain([d3.min(feuilles, function(d) {if (d.year == 2019) return d.value; }),
                d3.max(feuilles, function(d) {if (d.year == 2019) return d.value; })]);
      
     // Ajout des rectangles
      svg.selectAll(".rectTreemap")
      .data(feuilles)
  		.enter().append("rect")
      .attr("title", function(d) { return d.id + "\n" + format(d.value); })
      .attr("x", function (d) {return valuex + x(d.x0);})
      .attr("y", function (d) {return valuey + y(d.y0);})
      .attr("width", function (d) {return x(d.x1) - x(d.x0); })
      .attr("height", function (d) { return y(d.y1) - y(d.y0);})
      .attr("fill", function (d) {
        var year = d.id.substring(d.id.lastIndexOf(".")-4, d.id.lastIndexOf("."));
        if (year == 2016)
          return color2016(d.value)
        else if (year == 2017)
          return color2017(d.value)
        else if (year == 2018)
          return color2018(d.value)
        else if (year == 2019)
          return color2019(d.value)
        ;})
      .on('mousemove',  function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.season+" "+d.year+"<br>"+Arrondi(d.value)+" pas"+"<br>"+Pourcentage(d.pourcentage)+" des pas de l'année");
          })
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });;
      
      // Ajout des textes de date
      var periodeText = svg.selectAll(".periodeText")
    	.data(feuilles)
    	.enter()
    	.append("text")
      .attr("text-anchor", "middle")
     	.attr("dominant-baseline", "central")
     	.attr("x", function(d){ return valuex + d.x0 + (d.x1-d.x0)/2})
     	.attr("y", function(d){ return valuey + d.y0 + (d.y1-d.y0)/2 - 20})
     	.text(function(d){ if (d.x1-d.x0 > 50 && d.y1-d.y0 > 50)
      {return (d.season+" "+d.year)}})
     	.attr("class", "periodeText")
      .style("font-size", "12px")
     	.on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.season+" "+d.year+"<br>"+Arrondi(d.value)+" pas"+"<br>"+Pourcentage(d.pourcentage)+" des pas de l'année");
          })
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
      
     // Ajout des textes de nombres de pas
     var valueText = svg.selectAll(".valueText")
     .data(feuilles)
     .enter()
     .append("text")
     .attr("text-anchor", "middle")
     .attr("dominant-baseline", "central")
     .attr("x", function(d){ return valuex + d.x0 + (d.x1-d.x0)/2})
     .attr("y", function(d){ return valuey + d.y0 + (d.y1-d.y0)/2})
     .text(function(d){ if (d.x1-d.x0 > 50 && d.y1-d.y0 > 50){
      {return (Arrondi(d.value)+" pas")}}})
     .attr("class", "valueText")
     .style("font-size", "12px")
      .on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.season+" "+d.year+"<br>"+Arrondi(d.value)+" pas"+"<br>"+Pourcentage(d.pourcentage)+" des pas de l'année");
          })
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
      
     // Echelle de taille pour l'affichage des pourcentages
      var size = d3.scaleLinear()
      	.range([5,15])
      	.domain([0,0.5]);
      
     // Ajout des textes de pourcentages
      var pourcentageText = svg.selectAll(".pourcentageText")
    	.data(feuilles)
    	.enter()
    	.append("text")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "central")
      .attr("x", function(d){ return valuex + d.x0 + (d.x1-d.x0)/2})
      .attr("y", function(d){ return valuey + d.y0 + (d.y1-d.y0)/2 + 20})
      .text(function(d){ if (d.x1-d.x0 > 50 && d.y1-d.y0 > 50)
       {return (Pourcentage(d.pourcentage))}})
      .attr("class", "pourcentageText")
      .style("font-size", function(d) { if (d.pourcentage < 0.5){return size(d.pourcentage)} else {return 18} + "px"; })
      .on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.season+" "+d.year+"<br>"+Arrondi(d.value)+" pas"+"<br>"+Pourcentage(d.pourcentage)+" des pas de l'année");
          })
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
        
    })};
    
    
    
    
    // -----------------------------------------
    // Fonction permettant de tracer le boxplot
    // -----------------------------------------
    
    function boxplot(width,height,valuex,valuey,array){
      
      d3.csv('https://raw.githubusercontent.com/celine-d/PasAPas/master/Health%20Data_jour.csv', function(rawdata) { 
    
      rawdata.forEach(function(d, i){

        d.Date = parseDate(d.Start);
        d.Steps = +d['Steps (count)']
        d.Mois = dictMois[formatMois(d.Date)];
        d.Annee = formatAnnee(d.Date); 
        d.Jour = dictSemaine[formatJourSemaine(d.Date)];
        d.NumJour = formatJour(d.Date);

      })  
      
      // On supprime tous les éléments du boxplot afin de les remplacer par la suite
      svg.selectAll(".rectBoxplot").remove();
      svg.selectAll(".dot").remove();
      svg.selectAll("line").remove();
      svg.selectAll(".xText").remove();
      svg.selectAll(".yText").remove();
      svg.selectAll(".xAxis").remove();
      svg.selectAll(".yAxis").remove();
   
      // Filtre sur les années sélectionnées
   		data = rawdata.filter(function(d,i){return isInArray(+d.Annee, array)});
    
    	var data_dots = d3.nest()
    		.key(function(d){ return d.Jour;})
    		.entries(data);
      
    	var data_dots = data_dots.map(({key, values}) => ({Jour:key, values}));
        
      // On regroupe les données par jour de la semaine puis par année
      var nested = d3.nest()
          .key(function(d){ return d.Jour; })
          .key(function(d){ return d.Annee; })
          .entries(data); 
        
      // Préparation des données pour les boxplots

      var boxplot_data = nested.map(({key, values}) => ({Jour:key, values}));

      var min_global = Infinity;
      var max_global = 0;
        
      boxplot_data.forEach(function(d,i){
      	// On parcourt les jours de la semaine 
      
      	dat = d.values;
        var dat = dat.map(({key, values}) => ({Annee:key, values}));
      	d.values = dat; 
      
      	dat.forEach(function(e,j){
          // On parcourt les années
          
          dat2 = e.values;
          
          // On met les données dans l'ordre croissant selon le nombre de pas
          dat2.sort(function(x, y){
  					return d3.ascending(x.Steps, y.Steps);
					})
          
          // On met les nombres de pas dans une liste 
          var pas = []
          dat2.forEach(function(f,k){
            pas.push(f.Steps)
          }) 
        
          var quartile = [d3.quantile(pas, .25),
    	    	d3.quantile(pas, .5),
    				d3.quantile(pas, .75)];
          var whiskers = [d3.min(pas),d3.max(pas)];
          
          if (d3.min(pas) < min_global){
            	min_global = d3.min(pas)}
          
          if (d3.max(pas) > max_global){
            	max_global = d3.max(pas)}

          e.pas = pas;
          e.quartile = quartile;
          e.whiskers = whiskers;
          
        })
    })
      
      
     var Jours = boxplot_data.map(function(d) { return d.Jour; });
  	var Annees = boxplot_data[0].values.map(function(d) { return d.Annee; });
      
    // Axe vertical linéaire
    var y = d3.scaleLinear()
   	 	.range([height-50,0])
   		.domain([min_global,max_global]);

    // Groupes de boxplots (jour de la semaine)
		var x0 = d3.scaleBand()
    	.range([60, width-25], .2)
   	 	.padding(0.2)
    	.domain(Jours);

    // Boxplots dans chaque groupe (années)
		var x1 = d3.scaleBand()
    .range([0,x0.bandwidth() - .2])
    .padding(0.2)
  	.domain(Annees);
      
    // Axe des x
    var xAxis = d3.axisBottom()
   			.scale(x0);

    // Axe des y
		var yAxis = d3.axisLeft()
   			.scale(y);

    // Séparation en parties (pour les boxplots sans les points)
    var slice = svg.selectAll(".slice")
      .data(boxplot_data)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + valuex + x0(d.Jour) + ",0)"; });
      
    // Pour les points
    var slice2 = svg.selectAll(".slice")
      .data(data_dots)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + valuex + x0(d.Jour) + ",0)"; });

    // Ajout des lignes verticales
    slice.selectAll(".verticalLines")
    	.data(function(d){return d.values})
      .enter().append("line")
    	.attr("x1", function(d) {return  valuex + x1(d.Annee) + x1.bandwidth()/2;})
    	.attr("y1", function(d) {
        var whisker = d.whiskers[0];
        return valuey + y(whisker);})
    	.attr("x2", function(d) {return valuex + x1(d.Annee) + x1.bandwidth()/2;})
    	.attr("y2", function(d) {
        var whisker = d.whiskers[1];
        return valuey + y(whisker);})
      .attr("stroke","#000")
    	.attr("stroke-width", 1)
    	.attr("fill", "none");
      
    // Ajout des whiskers du haut
    slice.selectAll(".highwhiskersLines")
    	.data(function(d){return d.values})
      .enter().append("line")
    	.attr("x1", function(d) {return  valuex + x1(d.Annee);})
    	.attr("y1", function(d) {
        var whisker = d.whiskers[1];
        return valuey + y(whisker);})
    	.attr("x2", function(d) {return valuex + x1(d.Annee) + x1.bandwidth();})
    	.attr("y2", function(d) {
        var whisker = d.whiskers[1];
        return valuey + y(whisker);})
      .attr("opacity",0.5)
      .attr("stroke", "#000")
   		.attr("stroke-width", 1)
    	.attr("fill", "none");
      
    // Ajout des whiskers du bas
    slice.selectAll(".bottomwhiskersLines")
    	.data(function(d){return d.values})
      .enter().append("line")
    	.attr("x1", function(d) {return  valuex + x1(d.Annee);})
    	.attr("y1", function(d) {
        var whisker = d.whiskers[0];
        return valuey + y(whisker);})
    	.attr("x2", function(d) {return valuex + x1(d.Annee) + x1.bandwidth();})
    	.attr("y2", function(d) {
        var whisker = d.whiskers[0];
        return valuey + y(whisker);})
      .attr("opacity",0.5)
      .attr("stroke", "#000")
    	.attr("stroke-width", 1)
    	.attr("fill", "none");
      
    // Ajout des points
    slice2.selectAll(".dot")
    	.data(function(d){return d.values})
      .enter().append("circle")
      .attr("class", "dot")
     	.attr("r", 2.5)
      .attr("cx", function(d) { return valuex + x1(d.Annee) + x1.bandwidth()/2; })
      .attr("cy", function(d) { return valuey + y(d.Steps); }) 
    	.style("fill", function(d) { return colors[d.Annee] })
      .on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1]) + 'px')
            .html(d.NumJour +" "+d.Mois+ " "+d.Annee + "<br>"+Arrondi(d.Steps) + " pas")})
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
      
      // Ajout des rectangles
  		slice.selectAll(".rectBoxplot")
      	.data(function(d) { return d.values; })
  			.enter().append("rect")
      	.attr("x", function(d) { return valuex + x1(d.Annee); }) 
      	.attr("y", function(d) { return valuey + y(d.quartile[2])})
      	.attr("width", x1.bandwidth()) 
      	.attr("height", function(d) {
                          var quartiles = d.quartile;
                          var height = y(quartiles[0])-y(quartiles[2]);
                          return height;})
      	.style("fill", function(d) { return colors[d.Annee] })
     		.attr("stroke", "#000")
      	.attr("stroke-width", 1)
      	.attr("opacity",0.5)
      	.on('mousemove', function(d) {
        	var mouse = d3.mouse(svg.node()).map(function(d) {
            return parseInt(d);
          });
          tooltip.classed('hidden', false)
            .attr('style', 'left:' + (mouse[0] + 30) + 'px; top:' + (mouse[1] - 35) + 'px')
            .html(d.Annee + "<br>" + "1er quartile : "+Arrondi(d.quartile[0])+"<br>" + "Médiane : "+Arrondi(d.quartile[1])+"<br>" + "3ème quartile : "+Arrondi(d.quartile[2]));
          })
        .on('mouseout', function() {
        	tooltip.classed('hidden', true);
          });
      
      // Ajout des lignes médianes
      slice.selectAll(".medianLines")
    		.data(function(d){return d.values})
      	.enter().append("line")
    		.attr("x1", function(d) {return  valuex + x1(d.Annee);})
    		.attr("y1", function(d) {
        	var whisker = d.quartile[1];
        	return valuey + y(whisker);})
   	 		.attr("x2", function(d) {return valuex + x1(d.Annee) + x1.bandwidth();})
    		.attr("y2", function(d) {
        	var whisker = d.quartile[1];
        	return valuey + y(whisker);})
   	 		.attr("opacity",0.5)
    		.attr("stroke", "#000")
    		.attr("stroke-width", 1)
    		.attr("fill", "none")
        .attr("class",".medianLines");
      
      // Ajout de l'axe des x
     svg.append("g")
      	.attr("class", "xAxis")
      	.attr("transform", "translate(0," + 1.7*height + ")")
      	.call(xAxis);

     // Ajout du nom de l'axe x
      svg.append("text")              
     		.attr("x", width/2 - 40)
     		.attr("y", 1.82*height-margin.top+10 )
     		.text("Jour de la semaine")
     		.style("font-family","sans-serif")
     		.style("font-size","13px")
        .attr("class", "xText")
     
    	// Ajout de l'axe des y
  		svg.append('g')  
    		.attr('transform','translate(60,' + 0.93*height + ')')
  			.attr("class", 'yAxis')
  			.call(yAxis);
      
    	// Ajout du nom de l'axe des y

        svg.append("text")
     		.attr("transform", "rotate(-90)")
     		.attr("y", 0 - margin.left + 10)
     		.attr("x",0 - (1.6*height))
     		.attr("dy", "1em")
     		.text("Nombre de pas")
     		.style("font-family","sans-serif")
     		.style("font-size","13px")
        .attr("class","yText")

    })}
    
    
    
    // -----------------------------------------
    // Affichage par défaut de toutes les années
    // -----------------------------------------

     array = [2016,2017,2018,2019]
     treemap(width/2,height*0.4,width/2,height/2-40,array)
     boxplot(width/2,height*0.45,0,height/2-40,array)
     barchart(width/2,height*0.42,array)
     scatterplot(width/2,height*0.42,array)
  
   
    // -------------------------------------------
    // Mise à jour selon les années sélectionnées
    // -------------------------------------------
     
    function update(){
     array = [];
     if(d3.select("#check16").property("checked")){
       		array.push(2016)
     }
      if(d3.select("#check17").property("checked")){
       		array.push(2017)
     }
      if(d3.select("#check18").property("checked")){
       		array.push(2018)
     }
      if(d3.select("#check19").property("checked")){
       		array.push(2019)
     }
     treemap(width/2,height*0.4,width/2,height/2-40,array)
     boxplot(width/2,height*0.45,0,height/2-40,array)
     barchart(width/2,height*0.42,array)
     scatterplot(width/2,height*0.42,array)
    };
    
    d3.select("#check16").on("change",update);
    d3.select("#check17").on("change",update);
    d3.select("#check18").on("change",update);
    d3.select("#check19").on("change",update);
    
    d3.select("#distance_ref").on("change",function(){distance=d3.select(this).property("value"); update()})
    
    d3.select("#steps").on("change",function(){steps=d3.select(this).property("value"); update()})      
    
		d3.select("#ref").on("change",function(){ref=d3.select(this).property("value"); update()})  
    

  </script>
</body>
